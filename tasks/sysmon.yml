---

- name: Ensure dependencies are present
  ansible.builtin.package:
    name: "{{ sysmon_deps_pkgs }}"
    state: present

- name: Ensure sysmon package is installed - local build
  ansible.builtin.apt:
    deb: "{{ sysmon_build_dir }}/build/deb/sysmonforlinux_{{ sysmon_build_version }}-1_amd64.deb"
  when: sysmon_build and ansible_distribution == 'Ubuntu' and ansible_distribution_major_version | int <= 18

- name: Ensure sysmon package is installed - microsoft repo
  ansible.builtin.package:
    name: sysmonforlinux
    state: present
  when: not (sysmon_build and ansible_distribution == 'Ubuntu' and ansible_distribution_major_version | int <= 18)

- name: Ensure /opt/sysmon exists
  ansible.builtin.file:
    path: /opt/sysmon
    state: directory
    mode: '0700'

- name: Install sysmon service
  ansible.builtin.command: sysmon -accepteula -i
  args:
    creates: /etc/systemd/system/sysmon.service
  when:
    - ansible_service_mgr == 'systemd'
    - not is_container|bool

- name: Configure sysmon
  ansible.builtin.template:
    src: "{{ sysmon_template }}"
    dest: /opt/sysmon/config.xml
    mode: '600'
    validate: 'xmllint --noout %s'
    backup: "{{ sysmon_backup | default('yes') }}"
  notify:
    - Restart sysmon
